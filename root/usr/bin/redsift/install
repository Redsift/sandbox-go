#!/bin/bash

# GOPATH set in Dockerfile here only for reference:
# GOPATH=/usr/lib/redsift/workspace

if [ -n ${GITHUB_HTTP_TOKEN:-} ]; then
  git config --global url."https://$GITHUB_HTTP_TOKEN:@github.com".insteadOf "https://github.com"
  git config --global url."https://$GITHUB_HTTP_TOKEN:@github.com/".insteadOf "git@github.com:"
fi

cd $GOPATH/src/server
dep ensure
# NOTE: go-sandbox-rpc is the only shared dependency between sift and sandbox-go
# in order to work we need to delete it from all the /vendor folders so the cloned version
# in the GOPATH can be used for both. Otherwise there is a mismatch between
# sandbox-go/vendor and sandbox-go/sandbox/sift/vendor
rm -rf vendor/github.com/redsift/go-sandbox-rpc
go install ./...

cd $GOPATH/src/github.com/redsift/sandbox-go
exec /usr/bin/redsift/go_install $@
